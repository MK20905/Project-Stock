import dash
from dash import dcc, html, Input, Output, dash_table
import pandas as pd
import requests
from io import StringIO
from flask_caching import Cache
import plotly.graph_objs as go
from bs4 import BeautifulSoup


app = dash.Dash(__name__, suppress_callback_exceptions=True)

# Configure caching
cache = Cache(app.server, config={'CACHE_TYPE': 'SimpleCache', 'CACHE_DEFAULT_TIMEOUT': 600})

# Finviz export URL (Replace with your actual Finviz Elite token)
finviz_url = "https://elite.finviz.com/export.ashx?v=111&f=allYourFilters&auth=47eff682-6766-43ff-ac22-171365defff9"


@cache.memoize(timeout=600)
def fetch_finviz_data():
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    }
    response = requests.get(finviz_url, headers=headers)
    
    print(f"Fetching new data from Finviz... Status: {response.status_code}")  

    if response.status_code == 200:
        try:
            df = pd.read_csv(StringIO(response.text))
            df.columns = df.columns.map(str)  # Ensure all column names are strings
            print(df.head())  
            return df
        except Exception as e:
            print(f"Error parsing data from Finviz: {e}")
            return pd.DataFrame({"Error": ["Failed to parse data from Finviz"]})
    elif response.status_code == 429:
        print("Rate limit exceeded. Please try again later.")
        return pd.DataFrame({"Error": ["Rate limit exceeded. Please try again later."]})
    else:
        print(f"Failed to fetch data. Status code: {response.status_code}")
        return pd.DataFrame({"Error": [f"Failed to fetch data. Status code: {response.status_code}"]})
def fetch_finviz_historical_data(ticker_symbol):
    url = f"https://finviz.com/quote.ashx?t={ticker_symbol}"
    headers = {"User-Agent": "Mozilla/5.0"}
    response = requests.get(url, headers=headers)

    if response.status_code != 200:
        print(f"‚ùå Failed to fetch Finviz page for {ticker_symbol}")
        return pd.DataFrame()

    soup = BeautifulSoup(response.text, "html.parser")
    


    print(soup.prettify()[:1000])  # Debug: Print first 1000 characters of the HTML

    return pd.DataFrame()  
def fetch_detailed_stock_data(ticker_symbol):
    """
    Fetch stock details from Finviz.
    """
    df = fetch_finviz_data()
    detail_df = df[df['Ticker'] == ticker_symbol]

    if detail_df.empty:
        return pd.DataFrame({"Metric": ["No data available"], "Value": ["N/A"]})

    data = {
        "Market Cap": detail_df['Market Cap'].values[0] if 'Market Cap' in detail_df.columns else "N/A",
        "P/E": detail_df['P/E'].values[0] if 'P/E' in detail_df.columns else "N/A",
        "EPS (ttm)": detail_df['EPS'].values[0] if 'EPS' in detail_df.columns else "N/A",
        "Volume": detail_df['Volume'].values[0] if 'Volume' in detail_df.columns else "N/A",
        "52 Week High": detail_df['52W High'].values[0] if '52W High' in detail_df.columns else "N/A",
        "52 Week Low": detail_df['52W Low'].values[0] if '52W Low' in detail_df.columns else "N/A",
        "Target Price": detail_df['Target Price'].values[0] if 'Target Price' in detail_df.columns else "N/A"
    }

    return pd.DataFrame(data.items(), columns=["Metric", "Value"])



def main_page():
    df = fetch_finviz_data()
    if df.empty or "Error" in df.columns:
        return html.Div("No data available. Please check your Finviz configuration.", 
                        style={'textAlign': 'center', 'color': 'red'})

    return html.Div([
        html.H1("Stock Screener - Main Page", style={'textAlign': 'center', 'color': '#007BFF'}),
        html.Div([
            html.Button("Refresh Data", id="refresh-button", n_clicks=0, style={
                'backgroundColor': '#007BFF', 'color': 'white', 'padding': '10px 20px', 'borderRadius': '5px'
            }),
            dcc.RadioItems(
                id='refresh-interval-radio',
                options=[
                    {'label': '10s', 'value': 10},
                    {'label': '1min', 'value': 60},
                    {'label': '3min', 'value': 180},  
                    {'label': '5min', 'value': 300},  
                    {'label': 'off', 'value': 0},
                ],
                value=0, 
                labelStyle={'marginRight': '20px'}
            )
        ], style={'display': 'flex', 'alignItems': 'center', 'marginBottom': '20px'}),
        dcc.Interval(id='refresh-interval', interval=0, n_intervals=0),


        html.Div([
            html.Label("Sort By:"),
            dcc.Dropdown(
                id='sort-by-dropdown',
                options=[
                    {'label': col, 'value': col} for col in df.columns 
                ],
                value='Ticker',
                style={'width': '45%', 'display': 'inline-block', 'marginRight': '10px'}
            ),
            dcc.RadioItems(
                id='sort-order',
                options=[
                    {'label': 'Ascending', 'value': 'asc'},
                    {'label': 'Descending', 'value': 'desc'}
                ],
                value='asc',
                style={'display': 'inline-block'}
            )
        ], style={'marginBottom': '20px'}),

        # Main table
        dash_table.DataTable(
            id='main-table',
            columns=[{"name": col, "id": col} for col in df.columns],
            data=df.to_dict('records'),
            style_table={'overflowX': 'auto'},
            style_cell={'textAlign': 'left', 'padding': '5px'},
            style_header={'backgroundColor': '#f4f4f4', 'fontWeight': 'bold'},
            style_data_conditional=[
                {
                    'if': {'column_id': 'Ticker'},
                    'cursor': 'pointer',
                    'color': 'blue',
                    'textDecoration': 'underline',
                }
            ],
            page_size=10
        ),

        html.Div("Click on a ticker to view detailed analysis.",
                 style={'textAlign': 'center', 'marginTop': '10px'}),
    ])


def detail_page(ticker_symbol):
    details_df = fetch_detailed_stock_data(ticker_symbol)

    return html.Div([
        html.H1(f"Details for {ticker_symbol}", style={'textAlign': 'center', 'color': '#007BFF'}),

        html.Label("Timeframe:"),
        dcc.Dropdown(
            id='timeframe-dropdown',
            options=[
        {'label': '1 Second', 'value': '1s'},
        {'label': '1 Minute', 'value': '1m'},
        {'label': '5 Minutes', 'value': '5m'},
        {'label': '30 Minutes', 'value': '30m'},
        {'label': '1 Hour', 'value': '1h'},
        {'label': '1 Day', 'value': '1d'},
        {'label': '5 Days', 'value': '5d'},
        {'label': '1 Week', 'value': '1wk'},
        {'label': '1 Month', 'value': '1mo'},
    ],
            value='1d',
            style={'width': '50%', 'marginBottom': '20px'}
        ),

        html.Label("Select SMAs to display:"),
        dcc.Checklist(
            id='sma-options',
            options=[
                {'label': 'SMA20', 'value': 'SMA20'},
                {'label': 'SMA50', 'value': 'SMA50'},
                {'label': 'SMA200', 'value': 'SMA200'}
            ],
            value=['SMA20', 'SMA50'],  
            style={'marginBottom': '20px'}
        ),

        dcc.Graph(id='candlestick-chart'),

  
        html.H3("Volume", style={'textAlign': 'center'}),
        dcc.Graph(id='volume-chart'),


        html.H3("Stock Metrics", style={'textAlign': 'center'}),
        dash_table.DataTable(
            columns=[{"name": col, "id": col} for col in details_df.columns],
            data=details_df.to_dict('records'),
            style_table={'overflowX': 'auto'},
            style_cell={'textAlign': 'left', 'padding': '5px'},
            style_header={'backgroundColor': '#f4f4f4', 'fontWeight': 'bold'},
        ),

        # Link back to the main page
        dcc.Link('Back to Main Page', href='/', 
                 style={'textAlign': 'center', 'fontSize': '20px', 'color': '#007BFF'})
    ])


@app.callback(
    [Output('main-table', 'data'),
     Output('refresh-interval', 'interval')],
    [Input('refresh-button', 'n_clicks'),
     Input('refresh-interval-radio', 'value'),
     Input('sort-by-dropdown', 'value'),
     Input('sort-order', 'value')],
    prevent_initial_call=True
)


def update_main_table(n_clicks, refresh_value, sort_by, sort_order):
    print(f"Refresh triggered! Button Clicks: {n_clicks}, Auto-refresh Interval: {refresh_value}s") 
    if refresh_value == 0:  
        interval = 0
    else:
        interval = refresh_value * 1000  
    df = fetch_finviz_data()
    ascending = (sort_order == 'asc')
    df = df.sort_values(by=sort_by, ascending=ascending)
    return df.to_dict('records'), interval


@app.callback(
    Output('url', 'pathname'),
    [Input('main-table', 'active_cell')],
    [dash.dependencies.State('main-table', 'data')]
)
def navigate_to_ticker(active_cell, table_data):
    """
    Navigate to the detail page for the selected ticker when clicked in the main table.
    """
    if active_cell:
        row = active_cell['row']
        ticker_symbol = table_data[row]['Ticker'] 
        return f'/ticker/{ticker_symbol}' 
    return '/'
@app.callback(
    [Output('candlestick-chart', 'figure'), Output('volume-chart', 'figure')],
    [Input('timeframe-dropdown', 'value')],
    Input('url', 'pathname')
)
def update_detail_page(timeframe, pathname):
    if pathname.startswith('/ticker/'):
        ticker_symbol = pathname.split('/')[2]
        historical_data = fetch_finviz_historical_data(ticker_symbol)

        print(f"üîç Debugging Data for {ticker_symbol}:")
        print(historical_data.head())  # Print the first few rows

       
        if historical_data.empty:
            print(f"‚ö†Ô∏è No historical data available for {ticker_symbol}")
            return go.Figure(), go.Figure()

        required_columns = ["Date", "Open", "High", "Low", "Close", "Volume"]
        if not all(col in historical_data.columns for col in required_columns):
            print(f"‚ö†Ô∏è Missing required columns in data: {historical_data.columns}")
            return go.Figure(), go.Figure()

        candlestick_chart = go.Figure()
        candlestick_chart.add_trace(go.Candlestick(
            x=historical_data['Date'],
            open=historical_data['Open'],
            high=historical_data['High'],
            low=historical_data['Low'],
            close=historical_data['Close'],
            name='Candlestick'
        ))

        volume_chart = go.Figure()
        volume_chart.add_trace(go.Bar(
            x=historical_data['Date'], y=historical_data['Volume'],
            name='Volume'
        ))

        return candlestick_chart, volume_chart
    
    return go.Figure(), go.Figure()

@app.callback(
    Output('page-content', 'children'),
    Input('url', 'pathname')
)



def display_page(pathname):
    if pathname == '/' or pathname is None:
        return main_page()
    elif pathname.startswith('/ticker/'):
        ticker_symbol = pathname.split('/')[2]
        return detail_page(ticker_symbol)
    else:
        return html.H1("404: Page Not Found", style={'textAlign': 'center', 'color': 'red'})

app.layout = html.Div([
    dcc.Location(id='url', refresh=False),
    html.Div(id='page-content', children=main_page())
])

if __name__ == '__main__':
    app.run_server(debug=True)
